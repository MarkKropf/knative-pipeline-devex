#!/usr/bin/env ruby

require 'yaml'

git_ref = File.read('knative-docs-git/.git/ref').chomp
docker_image_digest = File.read('hello-world-image/digest').chomp
image_repository = ENV['GCR_REPOSITORY']

added_k8s_labels = <<-LABELS
      revisionTemplate:
        metadata:
          annotations:
            git-ref/knative-docs-git: #{git_ref}
            image-digest/hello-world-image: #{docker_image_digest}
LABELS
added_k8s_labels.chomp!

service_yaml = File.read('knative-docs-git/serving/samples/helloworld-ruby/service.yaml')

puts
puts 'Rewriting Knative Service YAML'
puts

service_yaml.gsub!('      revisionTemplate:', added_k8s_labels)
service_yaml.gsub!('docker.io/{username}/helloworld-ruby', "#{image_repository}@#{docker_image_digest}".chomp)

puts service_yaml

File.write('deployment-yaml/service.yaml', service_yaml)

puts
puts 'Done.'
puts
